rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // Leaderboard entries - read public, write with validation
    match /competitiveResults/{resultId} {
      allow read: if true;
      allow create: if request.resource.data.keys().hasAll(['username', 'score', 'timeSpent', 'difficulty', 'questionsCount', 'timestamp'])
                    && request.resource.data.username is string
                    && request.resource.data.username.size() >= 3
                    && request.resource.data.username.size() <= 20
                    && request.resource.data.score is number
                    && request.resource.data.score >= 0
                    && request.resource.data.score <= 100
                    && request.resource.data.timeSpent is number
                    && request.resource.data.questionsCount is number;
      allow update, delete: if false; // No updates or deletes allowed
    }

    // Practice results - read public, write with validation
    match /practiceResults/{resultId} {
      allow read: if true;
      allow create: if request.resource.data.keys().hasAll(['username', 'flagsLearned', 'practiceTime', 'timestamp'])
                    && request.resource.data.username is string
                    && request.resource.data.username.size() >= 3
                    && request.resource.data.flagsLearned is number
                    && request.resource.data.practiceTime is number;
      allow update, delete: if false;
    }

    // Leaderboard collection - read public, write with user authentication
    match /leaderboard/{entryId} {
      allow read: if true;
      allow create: if request.resource.data.keys().hasAll([
                      'user_id', 'username', 'rating', 'accuracy', 'totalTime',
                      'correctAnswers', 'totalQuestions', 'sessionId', 'createdAt'
                    ])
                    && request.resource.data.user_id is string
                    && request.resource.data.user_id.size() >= 10
                    && request.resource.data.username is string
                    && request.resource.data.username.size() >= 1
                    && request.resource.data.username.size() <= 100
                    && request.resource.data.rating is number
                    && request.resource.data.accuracy is number
                    && request.resource.data.accuracy >= 0
                    && request.resource.data.accuracy <= 100
                    && request.resource.data.totalTime is number
                    && request.resource.data.correctAnswers is number
                    && request.resource.data.totalQuestions is number
                    && request.resource.data.sessionId is string;
      allow update, delete: if false;
    }

    // Practice Results collection - private progress tracking
    // MVP Phase 1: Store practice quiz results for authenticated users
    // Privacy: Users can only read/write their own practice results
    match /practice_results/{resultId} {
      // Private read - users can only see their own practice results
      allow read: if request.auth != null
                  && resource.data.user_id == request.auth.uid;

      // Allow creation with strict validation
      // Schema: user_id, rank, score, total_questions, accuracy, total_time,
      //         average_time, session_id, completed_at, created_at
      allow create: if request.auth != null
                    && request.resource.data.user_id == request.auth.uid
                    && request.resource.data.keys().hasAll([
                        'user_id', 'rank', 'score', 'total_questions',
                        'accuracy', 'total_time', 'average_time',
                        'session_id', 'completed_at', 'created_at'
                      ])
                    && request.resource.data.user_id is string
                    && request.resource.data.user_id.size() >= 10
                    && request.resource.data.rank is string
                    && request.resource.data.rank.size() >= 2
                    && request.resource.data.rank.size() <= 10
                    && request.resource.data.score is number
                    && request.resource.data.score >= 0
                    && request.resource.data.total_questions is number
                    && request.resource.data.total_questions > 0
                    && request.resource.data.accuracy is number
                    && request.resource.data.accuracy >= 0
                    && request.resource.data.accuracy <= 100
                    && request.resource.data.total_time is number
                    && request.resource.data.total_time >= 0
                    && request.resource.data.average_time is number
                    && request.resource.data.average_time >= 0
                    && request.resource.data.session_id is string
                    && request.resource.data.session_id.size() >= 10;

      // Immutable - no updates or deletes (preserve practice history)
      allow update, delete: if false;
    }

    // Users collection - authentication and profile management
    match /users/{userId} {
      // Allow reading individual user documents by ID
      allow get: if true;

      // Fix: Allow device_id queries for auth initialization (Option 2: Secure)
      // Prevents "Missing or insufficient permissions" error in getUserByDeviceId()
      // Security: Limits queries to 1 result, preventing bulk data access
      // This supports device-based authentication without Firebase Auth
      allow list: if request.query.limit == 1;

      // Allow user creation with strict validation
      // Supported ranks: OC, AC, LC, MC, PO2, PO1, CPO2, CPO1, CIV, UnitO, NCMR
      // Security: Ensures user_id field matches the document ID to prevent spoofing
      allow create: if request.resource.data.keys().hasAll([
                      'user_id', 'rank', 'first_name', 'last_name',
                      'device_id', 'created_date', 'last_login'
                    ])
                    && request.resource.data.user_id == userId
                    && request.resource.data.rank is string
                    && request.resource.data.rank.size() >= 2
                    && request.resource.data.rank.size() <= 10
                    && request.resource.data.first_name is string
                    && request.resource.data.first_name.size() >= 1
                    && request.resource.data.first_name.size() <= 50
                    && request.resource.data.last_name is string
                    && request.resource.data.last_name.size() >= 1
                    && request.resource.data.last_name.size() <= 50
                    && request.resource.data.device_id is string
                    && request.resource.data.device_id.size() >= 10;

      // Allow updating specific fields only
      allow update: if request.resource.data.diff(resource.data)
                      .affectedKeys()
                      .hasOnly(['last_login', 'first_name', 'last_name', 'rank']);

      // No deletes allowed (data retention policy)
      allow delete: if false;
    }

    // Default deny all other collections
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
