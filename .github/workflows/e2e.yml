name: E2E Tests

on:
  pull_request:
    branches: [ master, main ]
  push:
    branches: [ master, main ]
  workflow_dispatch:

jobs:
  e2e-tests:
    name: Cypress E2E Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: 'npm'

      - name: Setup JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Install dependencies
        run: npm ci

      - name: Install Firebase Tools and Ionic CLI
        run: |
          npm install -g firebase-tools
          npm install -g @ionic/cli

      - name: Generate environment files
        run: |
          cat > src/environments/environment.ts << 'EOF'
          export const environment = {
            production: false,
            useEmulators: true,
            firebase: {
              apiKey: "fake-api-key-for-testing",
              authDomain: "localhost",
              projectId: "signalsmaster-40d2f",
              storageBucket: "signalsmaster-40d2f.firebasestorage.app",
              messagingSenderId: "303346601142",
              appId: "fake-app-id-for-testing",
              measurementId: "G-XXXXXXXX"
            },
            emulators: {
              firestore: {
                host: 'localhost',
                port: 8080
              },
              auth: {
                host: 'localhost',
                port: 9099
              }
            }
          };
          EOF

      - name: Start Firebase Emulators
        run: |
          firebase emulators:start --only firestore,auth --project signalsmaster-40d2f &
          echo $! > emulator.pid

          # Wait for Firestore emulator
          echo "Waiting for Firebase emulators..."
          npx wait-on http://127.0.0.1:4400 -t 120000 || {
            echo "Emulators failed to start. Checking logs..."
            cat firebase-debug.log 2>/dev/null || echo "No debug log found"
            kill $(cat emulator.pid) 2>/dev/null || true
            exit 1
          }

          echo "Firebase emulators ready!"

      - name: Start Ionic Dev Server
        run: |
          ionic serve --host=0.0.0.0 --port 8100 &
          echo $! > ionic.pid

          # Wait for Ionic dev server
          echo "Waiting for Ionic dev server..."
          npx wait-on http://localhost:8100 -t 300000 || {
            echo "Ionic server failed to start"
            kill $(cat ionic.pid) 2>/dev/null || true
            kill $(cat emulator.pid) 2>/dev/null || true
            exit 1
          }

          echo "Ionic dev server ready!"

      - name: Run Cypress Tests
        run: npm run e2e

      - name: Stop Servers
        if: always()
        run: |
          if [ -f ionic.pid ]; then
            kill $(cat ionic.pid) 2>/dev/null || true
            rm ionic.pid
          fi
          if [ -f emulator.pid ]; then
            kill $(cat emulator.pid) 2>/dev/null || true
            rm emulator.pid
          fi

      - name: Upload Cypress screenshots
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: cypress-screenshots
          path: cypress/screenshots/
          retention-days: 7
          if-no-files-found: ignore

      - name: Upload Cypress videos
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: cypress-videos
          path: cypress/videos/
          retention-days: 7
          if-no-files-found: ignore

      - name: Generate Cypress report
        if: always()
        run: |
          echo "## Cypress E2E Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "E2E tests completed. Check artifacts for details." >> $GITHUB_STEP_SUMMARY
