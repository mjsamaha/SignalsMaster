name: Deploy to Firebase

on:
  push:
    branches: [ master, main ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - preview

jobs:
  test:
    name: Run Tests Before Deploy
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run unit tests
        run: npm run test:ci

      - name: Check test coverage threshold
        run: |
          COVERAGE=$(grep -oP 'Lines\s+:\s+\K[0-9.]+' coverage/app/lcov-report/index.html | head -1 || echo "0")
          echo "Coverage: $COVERAGE%"
          if (( $(echo "$COVERAGE < 50" | bc -l) )); then
            echo "::warning::Coverage $COVERAGE% is below 50%"
          fi

  deploy:
    name: Deploy to Firebase Hosting
    needs: test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Generate environment files from secrets
        run: |
          # Create environment.ts for testing phase
          cat > src/environments/environment.ts << 'EOF'
          export const environment = {
            production: false,
            useEmulators: true,
            firebase: {
              apiKey: "fake-api-key-for-testing",
              authDomain: "localhost",
              projectId: "signalsmaster-40d2f",
              storageBucket: "signalsmaster-40d2f.firebasestorage.app",
              messagingSenderId: "303346601142",
              appId: "fake-app-id-for-testing",
              measurementId: "G-XXXXXXXX"
            },
            emulators: {
              firestore: {
                host: 'localhost',
                port: 8080
              },
              auth: {
                host: 'localhost',
                port: 9099
              }
            }
          };
          EOF
          # Create environment.prod.ts for production build
          cat > src/environments/environment.prod.ts << 'EOF'
          export const environment = {
            production: true,
            useEmulators: false,
            firebase: {
              apiKey: "${{ secrets.FIREBASE_API_KEY }}",
              authDomain: "${{ secrets.FIREBASE_AUTH_DOMAIN }}",
              projectId: "${{ secrets.FIREBASE_PROJECT_ID }}",
              storageBucket: "${{ secrets.FIREBASE_STORAGE_BUCKET }}",
              messagingSenderId: "${{ secrets.FIREBASE_MESSAGING_SENDER_ID }}",
              appId: "${{ secrets.FIREBASE_APP_ID }}",
              measurementId: "${{ secrets.FIREBASE_MEASUREMENT_ID }}"
            },
            emulators: {
              firestore: {
                host: 'localhost',
                port: 8080
              },
              auth: {
                host: 'localhost',
                port: 9099
              }
            }
          };
          EOF

      - name: Build production
        run: npm run build:prod

      - name: Deploy to Firebase Hosting
        uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: '${{ secrets.GITHUB_TOKEN }}'
          firebaseServiceAccount: '${{ secrets.FIREBASE_SERVICE_ACCOUNT_SIGNALSMASTER_40D2F }}'
          channelId: ${{ github.event.inputs.environment == 'preview' && 'preview' || 'live' }}
          projectId: signalsmaster-40d2f
        env:
          FIREBASE_CLI_PREVIEWS: hostingchannels

      - name: Deploy Firestore rules
        if: github.event.inputs.environment != 'preview'
        run: |
          npm install -g firebase-tools
          firebase deploy --only firestore:rules --project signalsmaster-40d2f --token ${{ secrets.FIREBASE_TOKEN }}

      - name: Comment deployment URL on PR
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request' && github.event.inputs.environment == 'preview'
        with:
          script: |
            const comment = `## ðŸš€ Firebase Hosting Preview

            âœ… Preview deployed successfully!

            **Preview URL:** https://signalsmaster-40d2f--preview-<unique-id>.web.app

            _This preview will be available for 7 days._`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Deployment summary
        run: |
          echo "## ðŸŽ‰ Deployment Successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ github.event.inputs.environment || 'production' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Project:** signalsmaster-40d2f" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŒ **Live URL:** https://signalsmaster-40d2f.web.app" >> $GITHUB_STEP_SUMMARY
