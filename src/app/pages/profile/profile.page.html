<ion-header [translucent]="true">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/tabs/home"></ion-back-button>
    </ion-buttons>
    <ion-title>Profile</ion-title>
    <ion-buttons slot="end">
      <ion-button *ngIf="!isEditing" (click)="toggleEdit()">
        <ion-icon slot="icon-only" name="create-outline"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <ion-header collapse="condense">
    <ion-toolbar>
      <ion-title size="large">Profile</ion-title>
    </ion-toolbar>
  </ion-header>

  <div class="profile-container" *ngIf="currentUser">
    <!-- User Badge Section -->
    <div class="profile-header">
      <app-user-badge [user]="currentUser" size="large"></app-user-badge>
      <div class="account-info">
        <p class="account-age">Member for {{ getAccountAge() }} days</p>
        <p class="device-id">Device ID: {{ currentUser.device_id.substring(0, 8) }}...</p>
      </div>
    </div>

    <!-- Success Message -->
    <ion-card *ngIf="successMessage" class="message-card success-card" color="success">
      <ion-card-content>
        <ion-icon name="checkmark-circle-outline"></ion-icon>
        {{ successMessage }}
      </ion-card-content>
    </ion-card>

    <!-- Error Message -->
    <ion-card *ngIf="errorMessage" class="message-card error-card" color="danger">
      <ion-card-content>
        <ion-icon name="alert-circle-outline"></ion-icon>
        {{ errorMessage }}
      </ion-card-content>
    </ion-card>

    <!-- Profile Form -->
    <form [formGroup]="profileForm" (ngSubmit)="onSave()" class="profile-form">
      <ion-list>
        <ion-list-header>
          <ion-label>Personal Information</ion-label>
        </ion-list-header>

        <!-- Rank -->
        <ion-item [class.ion-invalid]="hasError('rank')" lines="full">
          <ion-label position="stacked">Rank *</ion-label>
          <ion-select
            formControlName="rank"
            interface="action-sheet"
            placeholder="Select your rank"
            [interfaceOptions]="{header: 'Select Your Rank', cssClass: 'rank-select-action-sheet'}"
          >
            <ion-select-option *ngFor="let rank of availableRanks" [value]="rank">
              {{ getRankDisplayName(rank) }}
            </ion-select-option>
          </ion-select>
        </ion-item>
        <div class="error-message" *ngIf="hasError('rank')">
          {{ getErrorMessage('rank') }}
        </div>

        <!-- First Name -->
        <ion-item [class.ion-invalid]="hasError('firstName')" lines="full">
          <ion-label position="stacked">First Name *</ion-label>
          <ion-input
            formControlName="firstName"
            type="text"
            placeholder="Enter your first name"
            [clearInput]="true"
            autocomplete="given-name"
          ></ion-input>
        </ion-item>
        <div class="error-message" *ngIf="hasError('firstName')">
          {{ getErrorMessage('firstName') }}
        </div>

        <!-- Last Name -->
        <ion-item [class.ion-invalid]="hasError('lastName')" lines="full">
          <ion-label position="stacked">Last Name *</ion-label>
          <ion-input
            formControlName="lastName"
            type="text"
            placeholder="Enter your last name"
            [clearInput]="true"
            autocomplete="family-name"
          ></ion-input>
        </ion-item>
        <div class="error-message" *ngIf="hasError('lastName')">
          {{ getErrorMessage('lastName') }}
        </div>
      </ion-list>

      <!-- Edit Mode Actions -->
      <div class="action-buttons" *ngIf="isEditing">
        <ion-button
          expand="block"
          fill="clear"
          color="medium"
          (click)="toggleEdit()"
          [disabled]="isSaving"
        >
          Cancel
        </ion-button>
        <ion-button
          expand="block"
          type="submit"
          [disabled]="isSaving || profileForm.invalid || !profileForm.dirty"
        >
          <ion-spinner name="crescent" *ngIf="isSaving"></ion-spinner>
          <span *ngIf="!isSaving">Save Changes</span>
        </ion-button>
      </div>
    </form>

    <!-- Account Information -->
    <ion-list class="account-details">
      <ion-list-header>
        <ion-label>Account Details</ion-label>
      </ion-list-header>

      <ion-item lines="full">
        <ion-icon name="calendar-outline" slot="start"></ion-icon>
        <ion-label>
          <h3>Account Created</h3>
          <p>{{ toDate(currentUser.created_date) | date:'medium' }}</p>
        </ion-label>
      </ion-item>

      <ion-item lines="full">
        <ion-icon name="time-outline" slot="start"></ion-icon>
        <ion-label>
          <h3>Last Login</h3>
          <p>{{ toDate(currentUser.last_login) | date:'medium' }}</p>
        </ion-label>
      </ion-item>

      <ion-item lines="full" *ngIf="currentUser.is_admin">
        <ion-icon name="shield-checkmark-outline" slot="start" color="primary"></ion-icon>
        <ion-label color="primary">
          <h3>Administrator</h3>
          <p>You have admin privileges</p>
        </ion-label>
      </ion-item>
    </ion-list>

    <!-- Logout Button -->
    <div class="logout-section">
      <ion-button
        expand="block"
        fill="outline"
        color="danger"
        (click)="confirmLogout()"
        [disabled]="isEditing"
      >
        <ion-icon name="log-out-outline" slot="start"></ion-icon>
        Logout
      </ion-button>
      <p class="logout-note">
        Logging out will remove your profile from this device. You will need to register again.
      </p>
    </div>
  </div>

  <!-- Loading State -->
  <div class="loading-container" *ngIf="!currentUser">
    <ion-spinner name="crescent"></ion-spinner>
    <p>Loading profile...</p>
  </div>
</ion-content>
