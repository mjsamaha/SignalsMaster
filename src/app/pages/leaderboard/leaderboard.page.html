<ion-header [translucent]="true" class="safe-area-horizontal">
  <ion-toolbar>
    <ion-title>Leaderboard</ion-title>
  </ion-toolbar>
</ion-header>

<!-- FIX: Removed [fullscreen]="true" to prevent iOS scrolling conflicts. -->
<ion-content class="safe-area-padding">
  <!-- Pull-to-Refresh -->
  <ion-refresher slot="fixed" (ionRefresh)="handleRefresh($event)">
    <ion-refresher-content
      pullingIcon="chevron-down-circle-outline"
      pullingText="Pull to refresh leaderboard"
      refreshingSpinner="crescent"
      refreshingText="Refreshing...">
    </ion-refresher-content>
  </ion-refresher>

  <div class="container">
    <h1>Global Rankings</h1>

    <div *ngIf="entries.length === 0" class="leaderboard-empty">
      <!-- Section Header -->
      <div class="empty-state-section-header">GLOBAL RANKINGS</div>

      <!-- Top Divider -->
      <div class="empty-state-divider"></div>

      <!-- Main Icon -->
      <div class="empty-state-icon">üèÜ</div>

      <!-- Headline -->
      <h2 class="empty-state-headline">Accept the Challenge!</h2>

      <!-- Description -->
      <p class="empty-state-subheading">
        Claim your place at the top. Be the first to set the benchmark for the entire fleet
      </p>

      <!-- Action Buttons -->
      <div class="empty-state-buttons">
        <ion-button class="btn-compete" (click)="navigateToCompete()">
          <span class="btn-icon">‚ñ∂</span>
          Compete Now
        </ion-button>
      </div>

      <!-- Bottom Divider -->
      <div class="empty-state-divider"></div>

      <!-- Tier Preview Section (centered for empty state) -->
      <div class="tier-preview-container">
        <div class="tier-preview-title">RANK TIERS</div>
        <div class="tier-preview-subtitle">Rise through the fleet‚Äôs hierarchy</div>

        <div class="tier-list">
          <div class="tier-item">
              <div class="tier-badge">
                <img src="assets/feat/signals-master.png" alt="Signals Master" class="tier-badge-img" loading="lazy" decoding="async" />
              </div>
              <div class="tier-info">
                <div class="tier-name">Signals Master</div>
                <div class="tier-description">The highest-ranked signaller in the entire fleet</div>
              </div>
            </div>

          <div class="tier-item">
            <div class="tier-badge">
              <img src="assets/feat/top10.png" alt="Top 10 Signallers" class="tier-badge-img" loading="lazy" decoding="async" />
            </div>
            <div class="tier-info">
              <div class="tier-name">Top 10 Signallers</div>
              <div class="tier-description">Ranked among the fleet‚Äôs most reliable and high-performing signallers</div>
            </div>
          </div>

          <div class="tier-item">
            <div class="tier-badge">
              <img src="assets/feat/rising_star.png" alt="Rising Star" class="tier-badge-img" loading="lazy" decoding="async" />
            </div>
            <div class="tier-info">
              <div class="tier-name">Rising Star</div>
              <div class="tier-description">On track to join the fleet‚Äôs top-ranked signallers</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Tier Preview Section (visible when there are entries) -->
    <div *ngIf="entries.length > 0" class="tier-preview-container">
      <div class="tier-preview-title">RANK TIERS</div>
      <div class="tier-preview-subtitle">Rise through the fleet‚Äôs hierarchy</div>

      <div class="tier-list">
        <div class="tier-item">
          <div class="tier-badge">ü•á</div>
          <div class="tier-info">
            <div class="tier-name">Signals Master</div>
            <div class="tier-description">The highest-ranked signaller in the entire fleet</div>
          </div>
        </div>

        <div class="tier-item">
          <div class="tier-badge">ü•à</div>
          <div class="tier-info">
            <div class="tier-name">Top 10 Signallers</div>
            <div class="tier-description">Ranked among the fleet‚Äôs most reliable and high-performing signallers</div>
          </div>
        </div>

        <div class="tier-item">
          <div class="tier-badge">üåü</div>
          <div class="tier-info">
            <div class="tier-name">Rising Star</div>
            <div class="tier-description">On track to join the fleet‚Äôs top-ranked signallers</div>
          </div>
        </div>
      </div>
    </div>

    <div *ngIf="entries.length > 0" class="leaderboard-grid">
      <!-- Unified Card Structure for All Ranks -->
      <div *ngFor="let entry of entries; trackBy: trackByEntryId"
           class="leaderboard-card"
           [ngClass]="[getTierClass(entry.rank), getTopBorderClass(entry.rank), isCurrentUser(entry.username) ? 'current-user' : '']">

        <!-- Header Row: Badge + Username + Rating -->
        <div class="card-header">
          <div class="user-info">
            <span *ngIf="entry.rank !== 1" class="badge">{{ getTierBadge(entry.rank) }}</span>
            <img *ngIf="entry.rank === 1"
                 src="assets/feat/signals_master.gif"
                 alt="Signals Master ‚Äî top rank"
                 class="badge-gif"
                 loading="lazy"
                 decoding="async" />
            <span class="username">{{ entry.username }}</span>
            <span *ngIf="isCurrentUser(entry.username)" class="you-badge">YOU</span>
          </div>
          <div class="rating">
            <span class="rating-value">{{ entry.rating }}</span>
            <span class="rating-label">RATING</span>
          </div>
        </div>

        <!-- Rank Achievement Label -->
        <div class="rank-label">
          {{ getTierLabel(entry.rank) }}
        </div>

        <!-- Inline Stats Row -->
        <div class="stats-row">
          <span class="stat-item">{{ entry.correctAnswers }}/{{ entry.totalQuestions }} Correct</span>
          <span class="stat-divider">‚Ä¢</span>
          <span class="stat-item">{{ entry.accuracy.toFixed(1) }}% Accuracy</span>
          <span class="stat-divider">‚Ä¢</span>
          <span class="stat-item">{{ formatTime(entry.totalTime) }}</span>
        </div>
      </div>
    </div>

    <!-- Infinite Scroll -->
    <ion-infinite-scroll
      threshold="100px"
      (ionInfinite)="loadNextBatch($event)"
      [disabled]="!hasMoreEntries">
      <ion-infinite-scroll-content
        loadingSpinner="crescent"
        loadingText="Loading more rankings...">
      </ion-infinite-scroll-content>
    </ion-infinite-scroll>

    <!-- End of List Message -->
    <div *ngIf="!hasMoreEntries && entries.length > 0" class="end-of-list-message">
      <div class="end-icon">üèÅ</div>
      <p class="end-text">You've reached the end of the fleet!</p>
      <p class="end-subtext">{{ totalEntriesLoaded }} signallers ranked</p>
    </div>
  </div>
</ion-content>
