<ion-header [translucent]="true">
  <ion-toolbar>
    <ion-title>Competition Results</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <!-- Status Message -->
  <div *ngIf="submissionMessage" class="status-message" [class.success]="submissionSuccess" [class.error]="!submissionSuccess">
    <ion-text>{{ submissionSuccess ? '✓ ' : '✗ ' }}{{ submissionMessage }}</ion-text>
  </div>

  <div *ngIf="results" class="results-container">
    <!-- Hero Card (Color-Coded) -->
    <div class="hero-card" [class]="'hero-' + getRatingColor()">
      <div class="hero-content">
        <ion-text class="hero-title">COMPETITION COMPLETE!</ion-text>
        <div class="hero-score">
          <span class="score-label">Final Score:</span>
          <span class="score-value">{{ results.finalRating }}</span>
        </div>
        <div class="hero-meta">
          <span>{{ results.accuracy.toFixed(1) }}% Accuracy</span>
          <span class="separator">•</span>
          <span>{{ results.speedBonus.toFixed(1) }}/100 Speed Bonus</span>
          <span class="separator">•</span>
          <span>{{ getPerformanceEmoji() }} {{ getPerformanceTier() }}</span>
        </div>
        <ion-text class="hero-motivational">{{ getMotivationalMessage() }}</ion-text>
      </div>
    </div>

    <!-- Performance Metrics Grid -->
    <div class="metrics-grid">
      <div class="metric-card">
        <div class="metric-label">ACCURACY</div>
        <div class="metric-value">{{ results.accuracy.toFixed(1) }}%</div>
        <div class="metric-progress">
          <div class="progress-bar" [style.width.%]="results.accuracy"></div>
        </div>
      </div>

      <div class="metric-card">
        <div class="metric-label">SPEED BONUS</div>
        <div class="metric-value">{{ results.speedBonus.toFixed(1) }} / 100</div>
        <div class="metric-progress">
          <div class="progress-bar speed-bonus" [style.width.%]="Math.min(results.speedBonus, 100)"></div>
        </div>
      </div>

      <div class="metric-card">
        <div class="metric-label">TOTAL TIME</div>
        <div class="metric-value">{{ formatTime(results.totalTime) }}</div>
        <div class="metric-sub">{{ (results.totalTime / 60).toFixed(1) }} min</div>
      </div>

      <div class="metric-card">
        <div class="metric-label">AVG/QUESTION</div>
        <div class="metric-value">{{ results.averageTimePerQuestion.toFixed(1) }}s</div>
        <div class="metric-sub">{{ getSpeedComparison() }}</div>
      </div>
    </div>

    <!-- Score Calculation -->
    <div class="score-breakdown">
      <div class="breakdown-header">SCORE CALCULATION</div>
      <div class="breakdown-row">
        <span class="breakdown-label">Base Score ({{ results.accuracy.toFixed(1) }}% accuracy)</span>
        <span class="breakdown-value">{{ results.baseRating.toFixed(0) }} points</span>
      </div>
      <div class="breakdown-row">
        <span class="breakdown-label">× 0.7 weight</span>
        <span class="breakdown-value">{{ (results.baseRating * 0.7).toFixed(0) }} points</span>
      </div>
      <div class="breakdown-row">
        <span class="breakdown-label">Speed Bonus ({{ results.speedBonus.toFixed(1) }}/100)</span>
        <span class="breakdown-value">{{ results.speedBonus.toFixed(0) }} points</span>
      </div>
      <div class="breakdown-row">
        <span class="breakdown-label">× 0.3 weight</span>
        <span class="breakdown-value">{{ (results.speedBonus * 0.3).toFixed(0) }} points</span>
      </div>
      <div class="breakdown-divider"></div>
      <div class="breakdown-row total">
        <span class="breakdown-label">Final Score</span>
        <span class="breakdown-value">{{ results.finalRating }} points</span>
      </div>
    </div>

    <!-- Question Details -->
    <div class="question-details">
      <div class="question-header-section">
        <span class="question-section-title">QUESTION DETAILS</span>
      </div>
      <div class="question-list">
        <div *ngFor="let answer of getDisplayedQuestions(); let i = index"
             class="question-row"
             [class.correct]="answer.isCorrect"
             [class.incorrect]="!answer.isCorrect">
          <span class="question-number">Q{{ i + 1 }}</span>
          <span class="question-flag">{{ answer.flag.name }}</span>
          <span class="question-time">{{ formatTime(answer.timeSpent) }}</span>
          <span class="question-status" [class.correct]="answer.isCorrect" [class.incorrect]="!answer.isCorrect">
            {{ answer.isCorrect ? '✓ Correct' : '✗ Incorrect' }}
          </span>
        </div>
      </div>
      <button *ngIf="results.answers.length > 5" class="toggle-questions-btn" (click)="toggleQuestions()">
        {{ showAllQuestions ? 'Show Less' : 'Show All ' + results.answers.length + ' Questions' }}
      </button>
    </div>

    <!-- Submit Section -->
    <div class="submit-section">
      <p class="submit-prompt">Review your results above, then submit to the leaderboard below</p>
      <ion-button
        *ngIf="!hasSubmitted && !isSubmitting"
        expand="block"
        (click)="submitScore()"
        class="submit-btn">
        <ion-icon name="cloud-upload" slot="start"></ion-icon>
        Submit to Leaderboard
      </ion-button>

      <ion-button
        *ngIf="isSubmitting"
        expand="block"
        disabled="true"
        class="submit-btn submitting">
        <ion-icon name="sync" slot="start" class="spinning"></ion-icon>
        Submitting...
      </ion-button>

      <ion-button
        *ngIf="hasSubmitted"
        expand="block"
        disabled="true"
        class="submit-btn submitted">
        <ion-icon name="checkmark-circle" slot="start"></ion-icon>
        Submitted Successfully
      </ion-button>
    </div>

    <!-- Action Buttons -->
    <div class="action-buttons">
      <div class="primary-actions">
        <ion-button
          expand="block"
          (click)="tryAgain()"
          class="btn-try-again">
          <ion-icon name="refresh" slot="start"></ion-icon>
          Try Again
        </ion-button>

        <ion-button
          expand="block"
          (click)="viewLeaderboard()"
          class="btn-leaderboard">
          <ion-icon name="trophy" slot="start"></ion-icon>
          View Leaderboard
        </ion-button>
      </div>

      <ion-button
        expand="block"
        fill="outline"
        (click)="goHome()"
        class="btn-home">
        <ion-icon name="home" slot="start"></ion-icon>
        Go Home
      </ion-button>
    </div>
  </div>

  <!-- Loading/Error State -->
  <div *ngIf="!results" class="loading-container">
    <div class="loading-message">
      <ion-text>Loading results...</ion-text>
    </div>
  </div>
</ion-content>
