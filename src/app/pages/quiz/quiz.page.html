<ion-header>
  <ion-toolbar>
    <ion-title>Quiz</ion-title>
    <ion-buttons slot="end">
      <ion-button *ngIf="mode === 'practice'" (click)="restartQuiz()" fill="clear">
        <ion-icon name="refresh" slot="icon-only"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding">
  <div *ngIf="!quizCompleted; else resultsView">
    <!-- Progress indicator -->
    <div class="progress-container">
      <ion-text>Question {{ currentQuestion?.questionNumber }} of {{ currentQuestion?.totalQuestions }}</ion-text>
      <ion-progress-bar
        [value]="currentQuestion ? (currentQuestion.questionNumber / currentQuestion.totalQuestions) : 0">
      </ion-progress-bar>
    </div>

    <!-- Timer and Score display -->
    <div class="score-container">
      <ion-text *ngIf="mode === 'practice'">Timer: {{ formatTime(currentQuestionTime) }}</ion-text>
      <ion-text>Score: {{ (mode === 'practice' ? practiceSession?.currentScore : quizState?.score) || 0 }} / {{ currentQuestion?.totalQuestions }}</ion-text>
      <ion-text>Accuracy: {{ getAccuracyDisplay() }}</ion-text>
    </div>

    <!-- Question -->
    <div *ngIf="currentQuestion" class="question-container">
      <!-- Flag image -->
      <div class="flag-container">
        <img [src]="currentQuestion.flag.imagePath"
             [alt]="currentQuestion.flag.name"
             (load)="onImageLoad()"
             [class.loading]="imageLoading">
        <ion-spinner *ngIf="imageLoading" name="crescent"></ion-spinner>
      </div>

      <!-- Question text -->
      <ion-text class="question-text">
        {{ currentQuestion.quizType === 'identify-name' ?
           'What is the name of this flag?' :
           'What does this flag mean?' }}
      </ion-text>

      <!-- Answer options -->
      <div class="options-container">
        <ion-button *ngFor="let option of currentQuestion.options"
                   expand="block"
                   [color]="getButtonColor(option.id)"
                   (click)="onAnswerSelected(option.id)"
                   [disabled]="feedbackVisible">
          {{ option.text }}
          <ion-icon *ngIf="feedbackVisible && option.id === selectedAnswerId"
                   [name]="feedbackCorrect ? 'checkmark' : 'close'"
                   slot="end"></ion-icon>
          <ion-icon *ngIf="feedbackVisible && option.id === currentQuestion.correctAnswerId"
                   name="checkmark"
                   slot="end"></ion-icon>
        </ion-button>
      </div>

      <!-- Feedback message -->
      <div *ngIf="feedbackVisible" class="feedback-message"
           [class.correct]="feedbackCorrect"
           [class.incorrect]="!feedbackCorrect">
        <ion-text>
          {{ feedbackCorrect ? 'Correct!' : 'Incorrect' }}
        </ion-text>
        <ion-text *ngIf="!feedbackCorrect" class="correct-answer">
          Correct answer: {{ getCorrectAnswerText() }}
        </ion-text>
      </div>

      <!-- Next button -->
      <ion-button *ngIf="nextButtonEnabled"
                 expand="block"
                 (click)="nextQuestion()"
                 class="next-button">
        {{ currentQuestion.questionNumber === currentQuestion.totalQuestions ? 'Finish' : 'Next' }}
      </ion-button>
    </div>
  </div>

  <!-- Results view -->
  <ng-template #resultsView>
    <div class="results-container" *ngIf="quizResults">
      <ion-text class="results-title">Quiz Complete!</ion-text>

      <div class="results-stats">
        <ion-text>Score: {{ quizResults.correctAnswers }} / {{ quizResults.totalQuestions }}</ion-text>
        <ion-text>Accuracy: {{ quizResults.accuracy | number:'1.0-1' }}%</ion-text>
        <ion-text>Time: {{ quizResults.totalTime | number:'1.0-1' }} seconds</ion-text>
        <ion-text>Rating: {{ quizResults.rating | number:'1.0-1' }}/100</ion-text>
      </div>

      <div class="results-actions">
        <ion-button expand="block" (click)="restartQuiz()">Try Again</ion-button>
        <ion-button expand="block" fill="outline" routerLink="/home">Back to Home</ion-button>
      </div>
    </div>
  </ng-template>

  <!-- Restart Confirmation Modal -->
  <ion-modal [isOpen]="showRestartConfirm" (didDismiss)="cancelRestart()">
    <ion-header>
      <ion-toolbar>
        <ion-title>Restart Practice Quiz</ion-title>
      </ion-toolbar>
    </ion-header>
    <ion-content class="ion-padding">
      <ion-text>
        Are you sure you want to restart this practice quiz? All current progress will be lost.
      </ion-text>
      <div class="modal-actions">
        <ion-button expand="block" (click)="cancelRestart()" fill="outline">
          Cancel
        </ion-button>
        <ion-button expand="block" (click)="confirmRestart()" color="danger">
          Restart
        </ion-button>
      </div>
    </ion-content>
  </ion-modal>
