<ion-header>
  <ion-toolbar>
    <ion-title>{{ mode === 'competitive' && username ? username + ' - Competition' : 'Quiz' }}</ion-title>
    <ion-buttons slot="end">
      <ion-button *ngIf="mode === 'practice'" (click)="restartQuiz()" fill="clear">
        <ion-icon name="refresh" slot="icon-only"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding">
  <div *ngIf="!quizCompleted; else resultsView">
    <!-- Compact metadata bar -->
    <div class="metadata-bar">
      <ion-text>
        Question {{ currentQuestion?.questionNumber }}/{{ currentQuestion?.totalQuestions }}
        <span *ngIf="mode === 'practice'" class="separator">•</span>
        <ion-icon *ngIf="mode === 'practice'" name="time-outline" class="metadata-icon"></ion-icon>
        <span *ngIf="mode === 'practice'">{{ formatTime(currentQuestionTime) }}</span>
        <span class="separator">•</span>
        <ion-icon name="stats-chart-outline" class="metadata-icon"></ion-icon>
        {{ getCurrentScore() }}/{{ currentQuestion?.totalQuestions }}
        <span class="separator">•</span>
        <ion-icon name="trending-up-outline" class="metadata-icon"></ion-icon>
        {{ getAccuracyDisplay() }}
      </ion-text>
    </div>

    <!-- Question -->
    <div *ngIf="currentQuestion" class="question-container">
      <!-- Flag card with feedback overlay -->
      <div class="flag-card">
        <div class="flag-container">
          <img [src]="currentQuestion.flag.imagePath"
               [alt]="currentQuestion.flag.name"
               (load)="onImageLoad()"
               [class.loading]="imageLoading">
          <ion-spinner *ngIf="imageLoading" name="crescent"></ion-spinner>
        </div>

        <!-- Feedback overlay -->
        <div *ngIf="feedbackVisible" class="feedback-overlay"
             [class.correct]="feedbackCorrect"
             [class.incorrect]="!feedbackCorrect">
          <div class="feedback-content">
            <ion-icon [name]="feedbackCorrect ? 'checkmark-circle' : 'close-circle'" class="feedback-icon"></ion-icon>
            <ion-text class="feedback-title">
              {{ feedbackCorrect ? 'Correct!' : 'Incorrect' }}
            </ion-text>
            <ion-text *ngIf="!feedbackCorrect" class="feedback-answer">
              {{ getCorrectAnswerText() }}
            </ion-text>
          </div>
        </div>
      </div>

      <!-- Question text -->
      <ion-text class="question-text">
        {{ currentQuestion.quizType === 'identify-name' ?
           'What is the name of this flag?' :
           'What does this flag mean?' }}
      </ion-text>

      <!-- Answer options - 2x2 grid -->
      <div class="options-grid">
        <ion-button *ngFor="let option of currentQuestion.options"
                   [color]="getButtonColor(option.id)"
                   (click)="onAnswerSelected(option.id)"
                   [disabled]="feedbackVisible"
                   class="option-button">
          <span class="option-text">{{ option.text }}</span>
        </ion-button>
      </div>

      <!-- Next button -->
      <ion-button *ngIf="nextButtonEnabled"
                 expand="block"
                 (click)="nextQuestion()"
                 class="next-button">
        {{ currentQuestion.questionNumber === currentQuestion.totalQuestions ? 'Finish' : 'Next' }}
      </ion-button>
    </div>
  </div>

  <!-- Results view -->
  <ng-template #resultsView>
    <div class="results-container" *ngIf="quizResults">
      <ion-text class="results-title">Quiz Complete!</ion-text>

      <div class="results-stats">
        <ion-text>Score: {{ quizResults.correctAnswers }} / {{ quizResults.totalQuestions }}</ion-text>
        <ion-text>Accuracy: {{ quizResults.accuracy | number:'1.0-1' }}%</ion-text>
        <ion-text>Time: {{ quizResults.totalTime | number:'1.0-1' }} seconds</ion-text>
        <ion-text>Rating: {{ quizResults.rating | number:'1.0-1' }}/100</ion-text>
      </div>

      <div class="results-actions">
        <ion-button expand="block" (click)="restartQuiz()">Try Again</ion-button>
        <ion-button expand="block" fill="outline" routerLink="/home">Back to Home</ion-button>
      </div>
    </div>
  </ng-template>

  <!-- Restart Confirmation Modal -->
  <ion-modal [isOpen]="showRestartConfirm" (didDismiss)="cancelRestart()">
    <ion-header>
      <ion-toolbar>
        <ion-title>Restart Practice Quiz</ion-title>
      </ion-toolbar>
    </ion-header>
    <ion-content class="ion-padding">
      <ion-text>
        Are you sure you want to restart this practice quiz? All current progress will be lost.
      </ion-text>
      <div class="modal-actions">
        <ion-button expand="block" (click)="cancelRestart()" fill="outline">
          Cancel
        </ion-button>
        <ion-button expand="block" (click)="confirmRestart()" color="danger">
          Restart
        </ion-button>
      </div>
    </ion-content>
  </ion-modal>
